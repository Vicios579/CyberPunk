<!DOCTYPE html>
<html lang="pt-BR">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
		<link rel="stylesheet" href="./css/global.css" />
		<link rel="stylesheet" href="./css/style.css" />
		<link rel="stylesheet" href="./css/cadastro.css" />
		<title>Cadastro</title>
	</head>
	<body>
		<div class="header">
			<a href="./index.html"><img src="./Assets/logos/logo_preta.svg" alt="Logo Cyberpunk" class="logo" /></a>

			<button>
				<span></span>
				<a href="./index.html">VOLTAR</a>
			</button>
		</div>

      <div class="cadastro-wrapper">
         <div class="cadastro-card">
            <div class="cadastro-card-title">
               <h1 class="text-highlight-red">CADASTRO</h1>
               <p>Crie sua conta no sistema de implantes</p>
            </div>
   
            <form>
               <div class="personal-info">
                  <h2>INFORMAÇÕES PESSOAIS</h2>
                  <div>
                     <label for="nome">NOME COMPLETO</label>
                     <input type="text" name="nome" id="nome">
                  </div>
                  <div>
                     <div>
                        <label for="nome">GÊNERO</label>
                        <select name="genero" id="genero">
                           <option disabled selected value="#">SELECIONE UMA OPÇÃO</option>
                           <option value="M">M</option>
                           <option value="F">F</option>
                        </select>
                     </div>
                     <div>
                        <label for="nome">DATA DE NASCIMENTO</label>
                        <input type="date" name="dtnasc" id="dtnasc">
                     </div>
                  </div>
                  <div>
                     <label for="nome">CPF</label>
                     <input type="text" name="cpf" id="cpf" maxlength="14" placeholder="000.000.000-00">
                  </div>
               </div>
   
               <div class="account-info">
                  <h2>INFORMAÇÕES DA CONTA</h2>
                  <div>
                     <label for="nome">E-MAIL</label>
                     <input type="email" name="email" id="email">
                  </div>
                  <div>
                     <label for="senha">SENHA</label>
                     <input type="password" name="senha" id="senha" >
                     <i onclick="mostrarSenha(event)" class="fa-solid fa-eye"></i>
                  </div>
                  <div>
                     <label for="nome">CONFIRMAR SENHA</label>
                     <input type="password" name="senha_confirma" id="senha_confirma" >
                     <i onclick="mostrarSenha(event)" class="fa-solid fa-eye"></i>
                  </div>
               </div>
            </form>
   
            <div class="register-button">
               <button onclick="cadastrar()">CADASTRAR</button>
               <p>
                  Já tem uma conta?
                  <a href="./login.html"><span>Faça login aqui</span></a>
               </p>
            </div>
         </div>
      </div>
	</body>
</html>

<script>
   function mostrarSenha(event) {
      var input = event.target.parentElement.children[1]
      var currentValue = input.value
      var eyeIcon = event.target

      if (input.type == "password") {
         input.type = "text"
         eyeIcon.className = "fa-solid fa-eye-slash"
      } else {
         input.type = "password"
         eyeIcon.className = "fa-solid fa-eye"
      }
   }

	function cadastrar() {
      var nomeVar = nome.value
		var emailVar = email.value
		var generoVar = genero.value
		var cpfVar = cpf.value
		var dtNascVar = dtnasc.value
		var senhaVar = senha.value
		var senhaConfirmacaoVar = senha_confirma.value

		// Verificando se há algum campo em branco
		if (nomeVar == "" || emailVar == "" || generoVar == "#" || cpfVar == "" || dtNascVar == "" || senhaVar == "" || senhaConfirmacaoVar == "") {
         alert("inputs em branco, erro")
         return
		}

      // Validando a senha
      var specialCharactes = ["!", '"', "#", "$", "%", "&", "'", "(", ")", "*", "+", ",", "-", ".", "/", ":", ";", "<", "=", ">", "?", "@", "[", "\\", "]", "^", "_", "{", "|", "}", "~"]

      for (var i = 0; i < specialCharactes.length; i++) {
         if (senhaVar.includes(specialCharactes[i])) break

         if (i == specialCharactes.length - 1) {
            alert("A senha precisa conter pelo menos 8 caracteres, uma letra maiúscula e um caractere especial")
            return
         }
      }

      if (senhaVar.length < 8 || senhaVar == senhaVar.toLowerCase() || senhaVar != senhaConfirmacaoVar) {
         alert("A senha precisa conter pelo menos 8 caracteres, uma letra maiúscula e um caractere especial")
         return
      }

      fetch("/usuarios/cadastrar", {
         method: "POST",
         headers: {"Content-Type": "application/json"},
         body: JSON.stringify({
				nomeServer: nomeVar,
				generoServer: generoVar,
				dtNascServer: dtNascVar,
				cpfServer: cpfVar,
				emailServer: emailVar,
				senhaServer: senhaVar,
				senhaConfirmacaoServer: senhaConfirmacaoVar
         })
      }).then(function(resposta) {
         alert("cadastrado com sucesso")
         console.log("resposta: ", resposta)

         if (resposta.ok) {
            resposta.json().then(function(json) {
               sessionStorage.ID_USUARIO = json[0].idUsuario;

               var idUsuarioLogado = sessionStorage.ID_USUARIO
               console.log("session storage definido para:", idUsuarioLogado)
   
               fetch(`/usuarios/definir/${idUsuarioLogado}`, {method: "POST"}).then(function(data) {
                  data.json().then(function(result) {
                     console.log("deu certo?", result)
                  })
               })
            })

         } else {
            throw "Houve um erro ao tentar realizar o cadastro!"
         }
      }).catch(function(erro) {
         console.log(`#ERRO: ${erro}`)
      })

      setTimeout(function() {
         window.location.href = "login.html"
      }, 2000)

      return false
   }
</script>